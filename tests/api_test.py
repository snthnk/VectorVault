from fastapi.testclient import TestClient
from src.main import app
from src.embedder import EmbeddingModel
from src.vector_store import VectorStore
from tests.test_persistance import texts_list as texts_list1
from tests.vector_search_test import texts_list as texts_list2

texts_list1 = [
    # 1. Экономика
    """Закон спроса и предложения является фундаментальным принципом рыночной экономики. Он гласит, что цена на товар устанавливается в точке равновесия между его доступным количеством (предложением) и желанием потребителей его купить (спросом). Этот механизм невидимо регулирует производство и потребление, направляя ресурсы туда, где они наиболее востребованы.""",

    # 2. Музыка
    """Музыка эпохи Барокко, представленная такими гениями, как Бах и Вивальди, характеризуется сложностью, пышностью и драматизмом. В ней широко использовался контрапункт — техника переплетения нескольких независимых мелодических линий. Произведения этого периода наполнены глубокими эмоциями и сложными орнаментами, отражая величие и динамику своего времени.""",

    # 3. Геология
    """Теория тектоники плит объясняет движение внешних слоев Земли. Наша планета покрыта огромными плитами, которые медленно дрейфуют, сталкиваются и расходятся. Именно на их стыках происходят самые мощные геологические процессы: землетрясения, извержения вулканов и формирование горных хребтов, таких как Гималаи, постоянно меняя облик планеты.""",

    # 4. Литература
    """Жанр антиутопии, яркими примерами которого являются "1984" Оруэлла и "О дивный новый мир" Хаксли, исследует общества, которые на первый взгляд кажутся идеальными, но скрывают тоталитарный контроль и подавление личности. Эти произведения служат мощным предостережением, анализируя опасности социальных и технологических тенденций современности.""",

    # 5. Океанология
    """Глубоководные гидротермальные источники, или "черные курильщики", – это уникальные экосистемы на дне океана. Здесь, в полной темноте, из разломов земной коры вырывается перегретая вода, насыщенная минералами. Вокруг них процветает жизнь, основанная не на солнечном свете, а на хемосинтезе, поддерживая существование удивительных организмов.""",

    # 6. Архитектура
    """Минимализм в архитектуре — это философия, стремящаяся к простоте и функциональности через отказ от излишеств. Для него характерны чистые линии, открытые пространства, нейтральные цвета и использование натуральных материалов, таких как бетон, стекло и дерево. Основная идея – не в пустоте, а в том, чтобы каждый элемент был значимым.""",

    # 7. Мифология
    """Скандинавская мифология рисует суровый и величественный мир, населенный богами, великанами и монстрами. В центре повествования — бог Один в поисках знаний, могучий Тор с его молотом и хитрый Локи. Эти мифы отражали представления викингов о мужестве, судьбе и неизбежности Рагнарёка — финальной битвы, ведущей к обновлению мира."""
]

texts_list2 = [
    # 1. Космос
    """Исследование Марса является одной из главных задач современной космонавтики. Роверы, такие как "Perseverance", ищут признаки древней микробной жизни и собирают образцы грунта. Ученые надеются, что будущие пилотируемые миссии смогут доставить эти образцы на Землю для детального анализа, что может кардинально изменить наше понимание о жизни во Вселенной.""",

    # 2. Технологии
    """Искусственный интеллект (ИИ) стремительно меняет наш мир. От голосовых помощников в смартфонах до сложных алгоритмов, анализирующих огромные объемы данных, ИИ уже стал частью повседневной жизни. Развитие нейронных сетей открывает новые возможности в медицине, науке и бизнесе, но также ставит важные этические вопросы перед обществом.""",

    # 3. Природа
    """Тропические леса Амазонки, часто называемые "легкими планеты", играют ключевую роль в регулировании глобального климата. Они поглощают углекислый газ и производят кислород. Это дом для миллионов видов растений и животных, многие из которых еще не открыты наукой. К сожалению, вырубка лесов представляет серьезную угрозу этому биоразнообразию.""",

    # 4. История
    """Изобретение книгопечатания Иоганном Гутенбергом в XV веке стало настоящей революцией. Оно сделало книги и знания доступными для широких масс, а не только для элиты. Это способствовало распространению идей Ренессанса, Реформации и научного прогресса, навсегда изменив ход европейской и мировой истории, ускорив развитие образования.""",

    # 5. Искусство
    """Импрессионизм – художественное течение, возникшее во Франции в XIX веке. Художники, такие как Клод Моне и Пьер Огюст Ренуар, стремились запечатлеть мимолетное впечатление от света и цвета. Они работали на открытом воздухе, используя короткие, видимые мазки, чтобы передать движение и атмосферу момента, а не фотографическую точность.""",

    # 6. Здоровье и спорт
    """Регулярные физические упражнения имеют огромное значение для здоровья. Они укрепляют сердечно-сосудистую систему, помогают контролировать вес и снижают риск многих хронических заболеваний. Кроме того, спорт способствует выработке эндорфинов, улучшая настроение и уменьшая стресс. Даже умеренная активность, такая как ежедневная ходьба, приносит ощутимую пользу организму.""",

    # 7. Кулинария
    """Хотя лепешки с начинкой существовали с древних времен, современная пицца родилась в Неаполе, Италия. Изначально это была простая еда для бедняков. Легенда гласит, что пицца "Маргарита" была создана в честь королевы Маргариты Савойской, а ее ингредиенты – томаты, моцарелла и базилик – символизировали цвета итальянского флага.""",

    # 8. Путешествия
    """Париж, столица Франции, по праву считается одним из самых романтичных городов мира. Его очарование кроется в уютных улочках Монмартра, величественной архитектуре Лувра и Эйфелевой башни, а также в атмосфере бесчисленных кафе. Прогулка вдоль Сены или посещение маленькой булочной за свежим круассаном оставляет незабываемые впечатления.""",

    # 9. Наука (Биология)
    """Молекула ДНК содержит генетические инструкции для развития и функционирования всех живых организмов. Ее структура в виде двойной спирали, открытая Уотсоном и Криком, является ключом к пониманию наследственности. Каждая "ступенька" этой спирали состоит из пар оснований, последовательность которых кодирует всю информацию о нас.""",

    # 10. Психология
    """Критическое мышление — это способность анализировать информацию, ставить под сомнение утверждения и формировать обоснованные выводы. Этот навык важен не только в учебе или работе, но и в повседневной жизни. Он помогает отличать факты от мнений, распознавать манипуляции и принимать более взвешенные и независимые решения в современном мире."""
]

texts_list = texts_list1 + texts_list2


# Инициализация state вручную для тестов
def setup_app():
    """Инициализирует app.state для тестирования"""
    if not hasattr(app.state, 'embedder'):
        app.state.embedder = EmbeddingModel()
        app.state.vector_store = VectorStore(app.state.embedder.get_embeddings_dim())
        app.state.vector_store.load()


# Вызываем инициализацию
setup_app()

# Создаем клиент
client = TestClient(app)

if __name__ == "__main__":
    # Health check
    print("=== Health Check ===")
    response = client.get("/health")
    print(response.json())
    print()

    # Clear
    print("=== Clear Index ===")
    response = client.post("/index/clear")
    print(response.json())
    print()

    # Index documents
    print("=== Index Documents ===")
    payload = {
        "documents": [
            {"text": text, "doc_id": None, "metadata": {}}
            for text in texts_list
        ]
    }
    response = client.post("/index", json=payload)
    print(response.json())
    print()

    # Health check after indexing
    print("=== Health Check After Indexing ===")
    response = client.get("/health")
    print(response.json())
    print()

    # Search
    print("=== Search ===")
    query = "искусственный интеллект"
    payload = {"query": query}
    response = client.post("/search", json=payload)
    print(response.json())